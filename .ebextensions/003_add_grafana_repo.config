commands:
  01_add_grafana_repo:
    command: |
      sudo wget -q -O /tmp/grafana.key https://rpm.grafana.com/gpg.key
      sudo rpm --import /tmp/grafana.key
      echo -e '[grafana]\nname=grafana\nbaseurl=https://rpm.grafana.com\nrepo_gpgcheck=1\nenabled=1\ngpgcheck=1\ngpgkey=https://rpm.grafana.com/gpg.key\nsslverify=1\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt' | sudo tee /etc/yum.repos.d/grafana.repo

  02_install_alloy:
    command: sudo yum install -y alloy

  03_install_unzip:
    command: sudo yum install -y unzip

  04_create_otel_dir:
    command: sudo mkdir -p /opt/otel

  05_download_otel_dotnet_agent:
  command: |
    sudo mkdir -p /opt/otel/tmp
    sudo wget https://github.com/open-telemetry/opentelemetry-dotnet-instrumentation/releases/latest/download/otel-dotnet-auto-install.sh -O /opt/otel/otel-dotnet-auto-install.sh
    sudo chmod +x /opt/otel/otel-dotnet-auto-install.sh
    cd /opt/otel

  06_create_pyro_dir:
    command: sudo mkdir -p /opt/pyroscope

  07_download_pyro_dotnet_agent:
    command: |
      sudo curl -s -L \
        https://github.com/grafana/pyroscope-dotnet/releases/download/v0.12.0-pyroscope/pyroscope.0.12.0-glibc-x86_64.tar.gz \
        | sudo tar xvz -C /opt/pyroscope

  08_set_permissions:
    command: |
      sudo chmod +x /opt/pyroscope/Pyroscope.Profiler.Native.so
      sudo chown -R webapp:webapp /opt/otel /opt/pyroscope

  09_restart_alloy:
    command: sudo systemctl restart alloy

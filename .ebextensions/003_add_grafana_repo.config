commands:
  01_add_grafana_repo:
    command: |
      wget -q -O /tmp/grafana.key https://rpm.grafana.com/gpg.key
      rpm --import /tmp/grafana.key
      echo -e '[grafana]\nname=grafana\nbaseurl=https://rpm.grafana.com\nrepo_gpgcheck=1\nenabled=1\ngpgcheck=1\ngpgkey=https://rpm.grafana.com/gpg.key\nsslverify=1\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt' | tee /etc/yum.repos.d/grafana.repo

  02_install_alloy:
    command: yum install -y alloy

  03_create_otel_dir:
    command: "mkdir -p /opt/otel"

  04_download_otel_dotnet_agent:
    command: |
      wget https://github.com/open-telemetry/opentelemetry-dotnet-instrumentation/releases/latest/download/otel-dotnet-auto-install.sh -O /opt/otel/otel-dotnet-auto-install.sh
      chmod +x /opt/otel/otel-dotnet-auto-install.sh
      cd /opt/otel && ./otel-dotnet-auto-install.sh

  05_create_pyro_dir:
    command: "mkdir -p /opt/pyroscope"

  06_download_pyro_dotnet_agent:
    command: |
      wget https://github.com/grafana/pyroscope-dotnet/releases/latest/download/Pyroscope.Profiler.Native.so -O /opt/pyroscope/Pyroscope.Profiler.Native.so
      wget https://github.com/grafana/pyroscope-dotnet/releases/latest/download/Pyroscope.dll -O /opt/pyroscope/Pyroscope.dll

  07_set_permissions:
    command: |
      chmod +x /opt/pyroscope/Pyroscope.Profiler.Native.so
      chown -R webapp:webapp /opt/otel /opt/pyroscope

  08_restart_alloy:
    command: systemctl restart alloy
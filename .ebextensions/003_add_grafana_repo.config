commands:
  01_download_alloy:
    command: |
      echo "[INFO] Downloading Grafana Alloy v1.12.2..."
      ALLOY_VERSION="1.12.2"
      RPM_FILE="alloy-${ALLOY_VERSION}-1.amd64.rpm"
      DOWNLOAD_URL="https://github.com/grafana/alloy/releases/download/v${ALLOY_VERSION}/${RPM_FILE}"

      curl -L -o /tmp/alloy.rpm "$DOWNLOAD_URL"

      if [ ! -s /tmp/alloy.rpm ]; then
          echo "[ERROR] Alloy RPM download failed."
          exit 1
      fi

  02_install_alloy:
    command: |
      echo "[INFO] Installing Alloy..."
      sudo rpm -Uvh /tmp/alloy.rpm || true

  03_prepare_directories:
    command: |
      echo "[INFO] Creating Alloy directories..."
      sudo mkdir -p /etc/alloy
      sudo mkdir -p /etc/systemd/system/alloy.service.d

  04_set_root_user:
    command: |
      echo "[INFO] Setting Alloy to run as root..."
      echo "[Service]" | sudo tee /etc/systemd/system/alloy.service.d/override.conf
      echo "User=root" | sudo tee -a /etc/systemd/system/alloy.service.d/override.conf
      echo "Group=root" | sudo tee -a /etc/systemd/system/alloy.service.d/override.conf

  05_reload_systemd:
    command: |
      echo "[INFO] Reloading systemd..."
      sudo systemctl daemon-reload

